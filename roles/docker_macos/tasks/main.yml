---
# tasks file for docker_macos

- name: Detect system architecture
  shell: uname -m
  register: system_arch_raw
  changed_when: false

- name: Detect real CPU architecture (Apple Silicon detection)
  shell: sysctl -n machdep.cpu.brand_string
  register: cpu_brand
  changed_when: false

- name: Set real architecture based on CPU
  set_fact:
    system_arch: "{{ 'arm64' if 'Apple' in cpu_brand.stdout else system_arch_raw.stdout }}"

- name: Set Docker CLI download URL based on architecture
  set_fact:
    docker_cli_url: "{{ 'https://download.docker.com/mac/static/stable/aarch64/docker-24.0.7.tgz' if system_arch == 'arm64' else 'https://download.docker.com/mac/static/stable/x86_64/docker-24.0.7.tgz' }}"
    docker_arch: "{{ 'aarch64' if system_arch == 'arm64' else 'x86_64' }}"

- name: Check if Docker CLI is already installed
  stat:
    path: /usr/local/bin/docker
  register: docker_cli_exists

- name: Download Docker CLI package
  get_url:
    url: "{{ docker_cli_url }}"
    dest: /tmp/docker-24.0.7.tgz
  when: not docker_cli_exists.stat.exists

- name: Extract Docker CLI package
  shell: tar -zxvf /tmp/docker-24.0.7.tgz
  args:
    chdir: /tmp
  when: not docker_cli_exists.stat.exists

- name: Install Docker CLI binaries to system location
  become: yes
  shell: |
    cp /tmp/docker/docker /usr/local/bin/
    chmod +x /usr/local/bin/docker
  when: not docker_cli_exists.stat.exists

- name: Clean up temporary files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/docker-24.0.7.tgz
    - /tmp/docker
  when: not docker_cli_exists.stat.exists

- name: Verify Docker CLI installation
  shell: docker --version
  register: docker_version_check
  failed_when: false

- name: Test Colima compatibility
  shell: colima version
  register: colima_version_check
  failed_when: false

- name: Display Docker CLI installation status
  debug:
    msg: |
      {% if docker_cli_exists.stat.exists %}
      âœ… Docker CLI jÃ¡ estava instalado em /usr/local/bin/docker
      {% else %}
      âœ… Docker CLI instalado com sucesso em /usr/local/bin/docker
      {% endif %}
      
      {% if docker_version_check.rc == 0 %}
      ğŸ³ Docker CLI: {{ docker_version_check.stdout }}
      {% else %}
      âŒ Erro na verificaÃ§Ã£o do Docker CLI
      {% endif %}
      
      {% if colima_version_check.rc == 0 %}
      ğŸš€ Colima detectado: {{ colima_version_check.stdout }}
      
      âœ… Agora vocÃª pode usar:
      - colima start
      - docker ps (apÃ³s colima start)
      {% else %}
      âš ï¸  Colima nÃ£o encontrado. Instale com: brew install colima
      {% endif %}
      
      ğŸ¯ Arquitetura: {{ system_arch }} ({{ docker_arch }})
      ğŸ’» CPU: {{ cpu_brand.stdout }}
      ğŸ“¦ Pacote: Docker CLI 24.0.7
      ğŸ“ BinÃ¡rio: /usr/local/bin/docker